---
title: 搞懂EventLoop
date: 2022-03-11 07:00:00
categories: 
	- 前端技术
	- 计算机通识
tags:
	- EventLoop
	- 事件驱动
---
> 作者：李旭光
> 引用请标明出处

# 前言
EventLoop 翻译过来就是事件循环，那啥是事件循环啊，这个要从javascript是如何执行的说起。
要知道javascript是一个运行在浏览器或者Node环境的*单线程*执行的脚本语言，但是为了解决单线程阻塞的问题，这里就引入了事件循环的机制，也就是我们常说的异步特性。

但是虽然都是JavaScript，都是事件循环，都有异步特性，但浏览器环境和Node环境的实现方式是不一样的，这里要先说明一下。
浏览器的事件循环是HTML定义的规范，而Node环境是利用libuv库实现的，这里我们先从浏览器的事件循环开始说。
<!-- more -->
## 浏览器的事件循环
首先我们要知道，浏览器的事件循环是有这么两个部分构成，一个叫做主线程（main thread），另一个叫做调用栈（call-stack），所有的任务（Task）都会被放到调用栈里，等待主线程调用，这个怎么理解呢，打个比方，主线程就像是物流配送中的传送带，如果没有快递往上放的时候，它是空的，当有快递包裹放上去的时候，它就开始运行，而你购买的产品要放倒包裹里，然后包裹在放到传送带上，最终被送到你家里，这里的传送带就是主线程，包裹就是调用栈，而购买的产品就是任务，不知道这样解释是否能好理解一些。

### 同步、异步任务
JavaScript中的任务有两种，一种是同步任务，另一种是异步任务。
- 同步任务会排着队，逐个执行
- 异步任务在执行得到结果后，将回调函数添加到任务队列中，等着主线程空了再执行。

### 调用栈
栈，是一种数据结构，后进先出（LIFO），后入栈的先执行，执行完后出栈执行栈顶新的那个函数，直到栈空，像个瓶子，只有一头有口。

### 任务队列
队列，也是一种数据结构，先进先出（FIFO），队头出，队尾进，先到先得，就像排队买东西，或者汽车排队过隧道。

### 任务
任务分为两种，一种叫做宏任务（MacroTask），另一种叫做微任务（MicroTask），首先他们都是**异步队列**中的任务，那它们之间是什么关系呢？简单说来就是微任务是VIP优先执行，全部微任务执行完之后才轮到普通用户宏任务执行，而且执行完一个后马上要看有没有新的微任务执行，有的话宏任务还得等着，就这样往复，看着像不像是在银行等着排队办业务的你（其实是我）。
![JavaScript的执行流程](https://pic3.zhimg.com/80/v2-eba59eaab15f8a27c1b58f69513f0c0e_1440w.jpg)
那么哪些是宏任务，哪些是微任务呢？看下表吧。

|宏任务|微任务|
|-|-|
| setTimeout、setInterval、js主代码、setImmediate(Node)、requestAnimationFrame(浏览器)|process.nextTick、Promise的then方法|

